<!DOCTYPE html>
<html>
  <head>
    <meta name="author" content="Martyn Smith - USGS NY WSC">
    <title>StreamStats Services Batch Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script    src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script> 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
    
    <script type="text/javascript">

        //var csvFile = 'https://raw.githubusercontent.com/USGS-WiM/StreamStats-Setup/master/batchTester/testSites.csv';
        var csvFile = './testSites.csv';
        var streamStatsServices = '/streamstatsservices';
        var streamStatsDelineationEndPoint = '/watershed.geojson';
        var streamStatsParametersEndPoint = '/parameters.json'
        var streamStatsOptions = {
            rcode: null,
            xlocation: null,
            ylocation: null,
            crs: '4326',
            simplify: true,
            includeparameters: false,
            includeflowtypes: false,
            includefeatures: true,
        };

        $(document).ready(function() {
            $('#loadCSV').click(function() {
                loadCSV(csvFile);
                streamStatsURL = $('#serverForm input[name=serverRadios]:checked').val() + streamStatsServices;
            });
        });

        function loadCSV(csvFile) {
            $.ajax({
                type: "GET",
                url: csvFile,
                dataType: "text",
                success: function(data) {
                    csvToObj(data);
                }
            });
        }

        function csvToObj(csv) {
            var siteList = $.csv.toObjects(csv);
            $('#main').append('<div class="alert alert-success" role="alert"><strong>'  + siteList.length + ' sites successfully loaded</strong></div>');
            $('#main').append('<p>Using server: <a href="' + streamStatsURL + '">' + streamStatsURL + '</a></p');
            processSites(siteList)
        }

        function processSites(siteList) {

            //loop over sites
            $.each(siteList, function(index, site) {
                console.log(site)
                streamStatsOptions.rcode = site.state;
                streamStatsOptions.rcode = 'NY';
                streamStatsOptions.xlocation = site.lng;
                streamStatsOptions.ylocation = site.lat;
                //streamStatsOptions.siteId = site.siteid;
                delineateBasin(streamStatsOptions);
            });
        }

        function delineateBasin(siteInfo) {

            //create main site container with delineation and basin characteristic columns
            var container = $('<div class="card"><div class="card-block"><h5><strong>Site:</strong> ' + streamStatsOptions.siteId + '<strong> State/Region:</strong> ' + streamStatsOptions.rcode + '</h5><div class="row"><div id="delineation_site_' + streamStatsOptions.siteId + '" class="col"><h6>Delineation</h6><div class="progress"><div id="delineation_progressBar_' + streamStatsOptions.siteId + '" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%">Delineation</div></div></div><div id="basinchars_site_' + streamStatsOptions.siteId + '" class="col"><h6>Basin Characteristics<h6></div></div></div></div>');

            $('#main').append(container);


            var start_time = new Date().getTime();

            $.ajax({
                url: streamStatsURL + streamStatsDelineationEndPoint,
                data: siteInfo,
                dataType: 'json',
                success: function(response) {
                    var siteId = this.url.split('siteId=')[1];
                    var workspaceId = response.workspaceID;
                    console.log('2',response);
                    //getBasinChars(workspaceId);
                    $('#delineation_progressBar_' + siteId).removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-success');
                    var request_time = (new Date().getTime() - start_time)/1000;
                    console.log('in complete:', siteId)
                    $('#delineation_site_' + siteId).append('<span>Delineation time: ' + request_time + ' seconds</span></br><button type="button" class="btn-sm btn-success">Show result on map</button>')
                },
                complete: function() {
                    // var siteId = this.url.split('siteId=')[1];
                    // var request_time = (new Date().getTime() - start_time)/1000;
                    // console.log('in complete:', siteId)
                    // $('#delineation_site_' + siteId).append('<span>Delineation time: ' + request_time + ' seconds</span></br><button type="button" class="btn-sm btn-success">Show result on map</button>')
                }
            });
        }
        
        function getBasinChars(workspaceId) {
            console.log('in get basin chars:',workspaceId);

            var rcode = workspaceId.substring(0,2);

            var start_time = new Date().getTime();
            $.ajax({
                url: streamStatsURL + streamStatsParametersEndPoint + '?rcode=NY&workspaceID=' + workspaceId + '&includeparameters=BSLOPCM,CENTROIDX,CENTROIDY,CONTOUR,CSL1085LO,CSL1085UP,CSL10_85,DRNAREA,EL1200,FOREST,JULAVPRE,JUNAVPRE,JUNMAXTMP,LAGFACTOR,LC11DEV,LC11IMP,LENGTH,MAR,MAYAVPRE,MXSNO,OUTLETX,OUTLETY,PRECIP,PRJUNAUG00,SLOPERATIO,SSURGOA,SSURGOB,STORAGE',
                // data: {
                //     rcode: rcode,
                //     workspaceID: workspaceId,
                //     includeparameters: 'BSLOPCM,CENTROIDX,CENTROIDY,CONTOUR,CSL1085LO,CSL1085UP,CSL10_85,DRNAREA,EL1200,FOREST,JULAVPRE,JUNAVPRE,JUNMAXTMP,LAGFACTOR,LC11DEV,LC11IMP,LENGTH,MAR,MAYAVPRE,MXSNO,OUTLETX,OUTLETY,PRECIP,PRJUNAUG00,SLOPERATIO,SSURGOA,SSURGOB,STORAGE'
                // },
                dataType: 'json',
                success: function(response) {
                    var siteId = this.url.split('siteId=')[1];
                    var workspaceId = response.workspaceID;
                    console.log('2',response);
                    getBasinChars(workspaceId);
                    $('#delineation_progressBar_' + siteId).removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-success');
                },
                complete: function() {
                    var siteId = this.url.split('siteId=')[1];
                    var request_time = (new Date().getTime() - start_time)/1000;
                    console.log('in complete:', siteId)
                    $('#delineation_site_' + siteId).append('<span>Delineation time: ' + request_time + ' seconds</span></br><button type="button" class="btn-sm btn-success">Show result on map</button>')
                }
            });
        }

    </script>
  </head>
  <body>
    <div class="container">
        <div class="header clearfix">
          <h3 class="text-muted">StreamStats Services Batch Tester</h3>
        </div>
  
        <div class="jumbotron" id="main">
                <fieldset id="serverForm" class="form-group">
                        <legend>Select a server to use</legend>
                        <div class="form-check">
                            <label class="form-check-label">
                                <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios1" value="https://streamstats.usgs.gov" checked>
                                Production Streamstats (https://streamstats.usgs.gov)
                            </label>
                        </div>
                        <div class="form-check">
                            <label class="form-check-label">
                                <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios2" checked value="https://test.streamstats.usgs.gov">
                                Test Streamstats (https://test.streamstats.usgs.gov)
                            </label>
                        </div>
                </fieldset>
                <button id="loadCSV" type="button" class="btn btn-primary">Load test sites from CSV File</button>
        </div>

        <footer class="footer">
          <p>&copy; Powered by WiM</p>
        </footer>
  
      </div> <!-- /container -->
  </body>
</html>