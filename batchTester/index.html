<!DOCTYPE html>
<html>
  <head>
    <meta name="author" content="Martyn Smith - USGS NY WSC">
    <title>StreamStats Services Batch Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
    <script src="https://cdn.rawgit.com/gnarf/jquery-ajaxQueue/master/dist/jquery.ajaxQueue.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">

    <style>
        .hide { display: none; }
    </style>
    
    <script type="text/javascript">

        var csvFile = 'https://raw.githubusercontent.com/USGS-WiM/StreamStats-Setup/master/batchTester/testSites.csv';
        var streamStatsURL;
        var streamStatsServices = '/streamstatsservices';
        var streamStatsDelineationEndPoint = '/watershed.geojson';
        var streamStatsParametersEndPoint = '/parameters.json'
        var streamStatsOptions = {
            rcode: null,
            xlocation: null,
            ylocation: null,
            crs: '4326',
            simplify: true,
            includeparameters: false,
            includeflowtypes: false,
            includefeatures: true,
        };
        var checkedValues;
        var csvLoaded = false;
        var requestCount = 0;

        $(document).ready(function() {
            
            $('#loadCSV').click(function() {
                //make sure this is only clicked one per session
                if (!csvLoaded) {
                    loadCSV(csvFile);          
                }
            });
        });

        function loadCSV(csvFile) {
            $.ajax({
                type: "GET",
                url: csvFile,
                dataType: "text",
                success: function(data) {
                    csvLoaded = true;
                    csvToObj(data);
                }
            });
        }

        function csvToObj(csv) {
            //conert CSV to json
            var siteList = $.csv.toObjects(csv);

            //write out status block
            $('#main').append('</br></br><div class="sites-loaded alert alert-success" role="alert"><strong>'  + siteList.length + ' site(s) successfully loaded from CSV</strong><br><p>Points loaded from: <a href="https://github.com/USGS-WiM/StreamStats-Setup/blob/master/batchTester/testSites.csv">Github</a></br>Compare results to: <a href="https://docs.google.com/document/d/1YAlVpkL46RTWRM-gMWR5w6XOXq5oQ24dHHH92H-ttVg/edit#">V3 - V4 Cloud comparison document</a></p>Select the site(s) you want to process:<div class="site-checkboxes form-check"></div></div>');

            //add select all button
            $('#main .sites-loaded').append('<br><button id="selectAllSites" type="button" class="btn-sm btn">Select All [PROCEED WITH CAUTION]</button></br>');
            $('#selectAllSites').click(function() {
                $("input:checkbox").attr('checked','checked');
            })      

            //loop over sites
            $.each(siteList, function(index, site) {
                //add site to checkbox value
                $('#main .sites-loaded').append('<label class="form-check-label"><input type="checkbox" value=' + JSON.stringify(site) + ' class="form-check-input">&nbsp;<strong>' + site.state + ':</strong> ' + site.siteid + '</label></br>');
            });
            
            //add process sites button
            $('#main .sites-loaded').append('<br><button id="processSites" type="button" class="btn btn-success">Process Sites</button>');
            $('#processSites').click(function() {
                processSites()
            })
        }

        function processSites() {
            //get URL from selected radio
            streamStatsURL = $('#serverForm input[name=serverRadios]:checked').val() + streamStatsServices;
            $('#main').append('<p>Using server: <a href="' + streamStatsURL + '">' + streamStatsURL + '</a></p>');

            //get selected sites from checkbox list
            checkedValues = $('input:checkbox:checked').map(function() {
                return JSON.parse(this.value);
            }).get();

            //kick of delineations for each site
            $.each(checkedValues, function(index, site) {
                delineateBasin(site.siteid)
            });
        }

        function siteLookup(siteid) {
            var returnSite = null;
            $.each(checkedValues, function(index, site) {
                if (siteid === site.siteid) {
                    returnSite = site;
                }
            });
            return returnSite;
        }

        function delineateBasin(siteid) {
            //get full site info
            var site = siteLookup(siteid);

            //create request object
            var siteInfo = {
                rcode: site.state,
                xlocation: site.lng,
                ylocation: site.lat,
                crs: 4326,
                simplify: true,
                includeparameters: false,
                includeflwotypes: false,
                includefeatures: true,
                siteId: site.siteid
            }
            console.log('in delineate:',siteInfo.siteId);

            //clone template main site container with delineation and basin characteristic columns
            var templateId = 'card_' + siteInfo.siteId;

            //if dif exists remove it
            if ($('#' + templateId).length) $('#' + templateId).remove();
            $("#template").clone().attr('id',templateId).appendTo("#main");

            //update cloned template metadata for this site
            $('#' + templateId + ' .siteid').text(siteInfo.siteId)
            $('#' + templateId + ' .rcode').text(siteInfo.rcode)
            $('#' + templateId + ' .lat').text(siteInfo.ylocation)
            $('#' + templateId + ' .lng').text(siteInfo.xlocation)

            //use ajaxQueue so all requests don't go at once: https://github.com/gnarf/jquery-ajaxQueue
            $.ajaxQueue({
                url: streamStatsURL + streamStatsDelineationEndPoint,
                data: siteInfo,
                //async: false,
                dataType: 'json',
                beforeSend: function (request, settings) {
                    start_time = new Date().getTime();
                },
                success: function(response, status, xhr) {

                    //do hostname stuff
                    var serverName = xhr.getResponseHeader("usgswim-hostname");
                    $('#' + templateId + ' .hostname').text(serverName);
                    var requestURL;
                    //if using load balanced url, need to rewrite url for basin characteristic request
                    (streamStatsURL === 'https://streamstats.usgs.gov/streamstatsservices') ? requestURL = 'https://' + serverName.toLowerCase() + '.streamstats.usgs.gov/streamstatsservices' : requestURL = streamStatsURL;

                    var siteId = this.url.split('siteId=')[1];
                    var workspaceId = response.workspaceID;
                    console.log('in delineation success:', siteId, workspaceId, response,'feature collection length:',response.featurecollection.length)

                    var request_time = (new Date().getTime() - start_time)/1000;

                    //make sure we have a basin and point
                    if (response.featurecollection.length === 2) {
                        //update progress bar and update time
                        $('#' + templateId + ' .delineation_progress').removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-success');
                        $('#' + templateId + ' .delineation').append('<span class="timer">' + request_time + ' seconds</span></br><button type="button" class="show-map btn btn-success">Show result on map</button></br></br>');
                    
                        //write out map
                        $('#' + templateId + ' .show-map').click(function() {

                            if ($('#map_' + siteId).length) {
                                if ($(this).text() === 'Show result on map') {
                                    $(this).text('Hide Map');
                                    $('#map_' + siteId).show();
                                    return;
                                } 
                                else {
                                    $(this).text('Show result on map');
                                    $('#map_' + siteId).hide();
                                }  
                            }
                            else {
                                $(this).text('Hide Map');
                                $('#' + templateId + ' .delineation').append('<div style="height: 400px;" id="map_' + siteId + '" </div>');
                                var map = L.map('map_' + siteId,{scrollWheelZoom:false});
                                var CartoDB_Positron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                                    subdomains: 'abcd',
                                    maxZoom: 19
                                }).addTo(map);
                                var watershed = L.geoJSON(response.featurecollection[1].feature).addTo(map);
                                var point = L.geoJSON(response.featurecollection[0].feature).addTo(map);
                                map.fitBounds(watershed.getBounds());
                            }
                        });

                        //kick off parameter request using new URL
                        getBasinChars(siteId, workspaceId, requestURL);
                    }

                    else {
                        $('#' + templateId + ' .delineation_progress').removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-danger');
                        $('#' + templateId + ' .delineation').append('</br></br><div class="alert alert-danger" role="alert"><strong>There was a problem with the delineation</strong><br>A watershed was not returned</br><button type="button" class="redelineate btn btn-danger">Retry</button></div>');

                        $('#' + templateId + ' .redelineate').click(function() {
                            delineateBasin(siteId);
                        });
                        return;
                    }
                },
                error: function (request, status, error) {
                    console.error("Error delineating basin", request, status, error);
                    $('#' + templateId + ' .delineation_progress').removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-danger');
                    $('#' + templateId + ' .delineation').append('</br></br><div class="alert alert-danger" role="alert"><strong>There was a problem with the delineation</strong><br>HTTP Error: ' + error + '<button type="button" class="redelineate btn btn-danger">Retry</button></div>');
                    
                    $('#' + templateId + ' .redelineate').click(function() {
                        delineateBasin(siteId);
                    });
                }

            });
        }
        
        function getBasinChars(siteId, workspaceId, requestURL) {
            console.log('in get basin chars:',siteId, workspaceId, requestURL);

            var rcode = workspaceId.substring(0,2);
            var templateId = 'card_' + siteId;

            //show progress bar
            $('#' + templateId + ' .parameter_progress_parent').show();
             
            var start_time = new Date().getTime();
            $.ajax({
                url: requestURL + streamStatsParametersEndPoint,
                data: {
                    rcode: rcode,
                    workspaceID: workspaceId,
                    includeparameters: true,
                    siteId: siteId
                },
                dataType: 'json',
                beforeSend: function (request, settings) {
                    start_time = new Date().getTime();
                },
                success: function(response) {
                    var workspaceId = this.url.split('workspaceId=')[1];
                    var siteId = this.url.split('siteId=')[1];
                    var templateId = 'card_' + siteId;
                    console.log('in getBasinChars success:', siteId, response)
                    
                    var request_time = (new Date().getTime() - start_time)/1000;

                    //update progress bar and update time
                    $('#' + templateId + ' .parameter_progress').removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-success');   
                    $('#' + templateId + ' .parameter').append('<span class="timer">' + request_time + ' seconds</span></br><button type="button" class="show-table btn btn-success">Show parameter table</button></br></br>')

                    //write out table
                    $('#' + templateId + ' .show-table').click(function() {

                        if ($('#table_' + siteId).length) {
                            if ($(this).text() === 'Show parameter table') {
                                $(this).text('Hide parameter table');
                                $('#table_' + siteId).show();
                                return;
                            } 
                            else {
                                $(this).text('Show parameter table');
                                $('#table_' + siteId).hide();
                            }  
                        }
                        else {
                            $(this).text('Hide parameter table');
                            $('#' + templateId + ' .parameter').append('<table id="table_' + siteId + '" class="table table-sm"><thead><tr><th>CODE</th><th>VALUE</th></tr></thead><tbody></tbody></table>');
                            $.each(response.parameters, function(key,value) {
                                $('#' + templateId + ' .table').find('tbody').append('<tr><td>' + value.code + '</td><td>' + value.value + '</td></tr>');
                            })
                        }
                    });
                },
                error: function(request, status, error) {
                    console.error("Error calculating basin characteristics", request, status, error);
                    $('#' + templateId + ' .parameter_progress').removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-danger');
                    $('#' + templateId + ' .parameter').append('</br></br><div class="alert alert-danger" role="alert"><strong>There was a problem with the parameter request</strong><br>HTTP Error: ' + error + '<button type="button" class="recalculate btn btn-danger">Retry</button></div>');
                    
                    $('#' + templateId + ' .recalculate').click(function() {
                        getBasinChars(siteId, workspaceId, requestURL);
                    });
                }
            });
        }

        //function for summing total request time
        $(document).ajaxStop(function() {
            if ($('.timer').length > 0) {
                var totalTime = 0;
                $('.timer').each(function(i, obj) {
                    totalTime += Number($(obj).text().split(' seconds')[0]);
                });

                var timeText = totalTime.toFixed(2) + ' seconds'
                if (totalTime > 60) {
                    var minutes = Math.floor(totalTime / 60);
                    var seconds = totalTime - minutes * 60;
                    timeText = minutes + ' minute(s) ' + seconds.toFixed(2) + ' seconds';
                }
                if ($('.total-time').length) $('.total-time').remove();
                $('#main').append('<span class="total-time"><strong>Total time:</strong> ' + timeText + '</span>');
            }
        });
     </script>
  </head>
  <body>
    <div class="container">
        <div class="header clearfix">
          <h3 class="text-muted">StreamStats Services Batch Tester</h3>
        </div>

        <!-- site progress template -->
        <div class="hide">
            <div id="template" class="card">
                <div class="card-block">
                    <dl class="row">
                        <dt class="col-sm-3">Site ID</dt>
                        <dd class="col-sm-9 siteid"></dd>
                        <dt class="col-sm-3">State/Region</dt>
                        <dd class="col-sm-9 rcode"></dd>
                        <dt class="col-sm-3">Latitude</dt>
                        <dd class="col-sm-9 lat"></dd>
                        <dt class="col-sm-3">Longitude</dt>
                        <dd class="col-sm-9 lng"></dd>
                        <dt class="col-sm-3">Hostname</dt>
                        <dd class="col-sm-9 hostname"></dd>
                    </dl>
                    <div class="row">
                        <div class="delineation col">
                            <h6>Delineation</h6>
                            <div class="progress">
                                <div class="delineation_progress progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                         </div>
                        <div class="parameter col">
                            <h6>Basin Characteristics</h6>
                            <div class="parameter_progress_parent" style="display:none;">
                                <div class="parameter_progress progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END site progress template -->
  
        <div class="jumbotron" id="main">
            <fieldset id="serverForm" class="form-group">
                <legend>Select a server to use</legend>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios2" checked value="https://test.streamstats.usgs.gov">
                        Test Streamstats (https://test.streamstats.usgs.gov)
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios1" value="https://streamstats.usgs.gov">
                        Production Streamstats [Load Balancer] (https://streamstats.usgs.gov)
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios3" value="https://bigkerna.streamstats.usgs.gov">
                        BigKernA Streamstats (https://bigkerna.streamstats.usgs.gov)
                    </label>
                </div>
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="radio" class="form-check-input" name="serverRadios" id="optionsRadios4" value="https://bigkernb.streamstats.usgs.gov">
                        BigKernB Streamstats (https://bigkernb.streamstats.usgs.gov)
                    </label>
                </div>
            </fieldset>
            <button id="loadCSV" type="button" class="btn btn-primary">Load test sites from CSV File</button>
        </div>

        <footer class="footer">
          <p>&copy; Powered by WiM</p>
        </footer>
  
      </div> <!-- /container -->
  </body>
</html>