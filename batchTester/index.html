<!DOCTYPE html>
<html>
  <head>
    <meta name="author" content="Martyn Smith - USGS NY WSC">
    <title>StreamStats Services Batch Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script    src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script> 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
    
    <script type="text/javascript">

        var csvFile = 'https://raw.githubusercontent.com/USGS-WiM/StreamStats-Setup/master/batchTester/testSites.csv';
        var streamStatsURL = 'https://test.streamstats.usgs.gov/streamstatsservices';
        var streamStatsDelineationEndPoint = '/watershed.geojson';
        var streamStatsOptions = {
            rcode: null,
            xlocation: null,
            ylocation: null,
            crs: '4326',
            includeparameters: false,
            includeflowtypes: false,
            includefeatures: true,
            simplify: true
        };

        $(document).ready(function() {
            loadCSV(csvFile);
        });

        function loadCSV(csvFile) {
            $.ajax({
                type: "GET",
                url: csvFile,
                dataType: "text",
                success: function(data) {
                    csvToObj(data);
                }
            });
        }

        function csvToObj(csv) {
            var siteList = $.csv.toObjects(csv);
            $('#main').append('<div class="alert alert-success" role="alert"><strong>CSV Loaded Successfully</strong> You successfully read this important alert message.</div>');
            $('#main').append('<p>Using server: <a href="' + streamStatsURL + '">' + streamStatsURL + '</a></p');
            processSites(siteList)
        }

        function processSites(siteList) {

            //loop over sites
            $.each(siteList, function(index, site) {
                console.log(site)
                streamStatsOptions.rcode = site.state;
                streamStatsOptions.xlocation = site.lng;
                streamStatsOptions.ylocation = site.lat;
                streamStatsOptions.siteId = site.siteid;
                delineateBasin(streamStatsOptions);
            });
        }

        function delineateBasin(siteInfo) {

            //create main site container with delineation and basin characteristic columns
            var container = $('<div class="card"><div class="card-block"><h5><strong>Site:</strong> ' + streamStatsOptions.siteId + '<strong> State/Region:</strong> ' + streamStatsOptions.rcode + '</h5><div class="row"><div id="delineation_site_' + streamStatsOptions.siteId + '" class="col"><h6>Delineation</h6><div class="progress"><div id="delineation_progressBar_' + streamStatsOptions.siteId + '" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%">Delineation</div></div></div><div id="basinchars_site_' + streamStatsOptions.siteId + '" class="col"><h6>Basin Characteristics<h6></div></div></div></div>');

            $('#main').append(container);


            var start_time = new Date().getTime();

            $.ajax({
                url: streamStatsURL + streamStatsDelineationEndPoint,
                data: siteInfo,
                dataType: 'json',
                success: function(response) {
                    var siteId = this.url.split('siteId=')[1];
                    var workspaceId = response.workspaceId;
                    console.log('2',workspaceId);
                    getBasinChars(workspaceId);
                    $('#delineation_progressBar_' + siteId).removeClass('progress-bar-animated').removeClass('progress-bar-striped').addClass('bg-success');
                },
                complete: function() {
                    var siteId = this.url.split('siteId=')[1];
                    var request_time = (new Date().getTime() - start_time)/1000;
                    $('#site' + siteId).append('<span>Delineation time: ' + request_time + ' seconds</span>')
                }
            });
        }
        
        function getBasinChars(workspaceId) {
            console.log('in get basin chars:',workspaceId)
        }

    </script>
  </head>
  <body>
    <div class="container">
        <div class="header clearfix">
          <h3 class="text-muted">StreamStats Services Batch Tester</h3>
        </div>
  
        <div class="jumbotron" id="main">
        </div>

        <footer class="footer">
          <p>&copy; Powered by WiM</p>
        </footer>
  
      </div> <!-- /container -->
  </body>
</html>