
<html>
<head>
	<title>Network Nav Test App</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"/>
	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.2.0/dist/leaflet.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
	
	<script src="https://cdn.jsdelivr.net/npm/leaflet@1.2.0/dist/leaflet.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@2.1.1/dist/esri-leaflet.js"></script>

	
		
    <style>
        html, body, #map { margin: 0; height: 100%; width: 100%; }
		.leaflet-touch .leaflet-bar button {
		  width: 140px;
		} 
		
		.leaflet-container.crosshair-cursor-enabled {
			cursor:crosshair;
		}
    </style>
</head>
<body>


<div id="map"></div>
<script>

	var map = L.map('map').setView([42.5, -73], 13);

	L.esri.basemapLayer("DarkGray").addTo(map);
	//L.esri.tiledMapLayer({url: 'https://basemap.nationalmap.gov/arcgis/rest/services/USGSHydroCached/MapServer'}).addTo(map);
	
	$.getJSON( "https://test.streamstats.usgs.gov/navigationservices/navigation", function( data ) {
		console.log('network nav options:',data);
		$(data).each(function(){	
			createNetworkNavTool(this);
		});
	});
	
	function createNetworkNavTool(item) {

		//raindrop trace
		if (item.code === 'flowpath') {
			L.easyButton({
				states: [{
					stateName: 'start',
					icon: '<span>' + item.name + '</span>',
					title: 'initial',
					onClick: function(control) {
						getNavigationInfo(control,item.code);
						control.state('add-start-point');
					}
				}, {
					icon: '<span><i class="fa fa-map-marker"></i> Click start point</span>',
					stateName: 'add-start-point',
					onClick: function(control) {
						L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
						map.off('click');
						control.state('start');
					},
					title: 'add markers'
				},
				{
					icon: '<i class="fa fa-cog fa-spin fa-fw"></i><span class="sr-only">Loading...</span>',
					stateName: 'loading',
					title: 'loading'
				}]
			}).addTo(map);
		}

		// if (item.code === 'networkpath') {
		// 	L.easyButton({
		// 		states: [{
		// 			stateName: 'start',
		// 			icon: '<span>' + item.name + '</span>',
		// 			title: 'initial',
		// 			onClick: function(control) {
		// 				getNavigationInfo(control,item.code);
		// 				control.state('add-start-point');
		// 			}
		// 		}, {
		// 			icon: '<span><i class="fa fa-map-marker"></i> Click start point</span>',
		// 			stateName: 'add-start-point',
		// 			onClick: function(control) {
		// 				L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
		// 				map.off('click');
		// 				control.state('start');
		// 			},
		// 			title: 'add markers'
		// 		},
		// 		{
		// 			icon: '<i class="fa fa-cog fa-spin fa-fw"></i><span class="sr-only">Loading...</span>',
		// 			stateName: 'loading',
		// 			title: 'loading'
		// 		}]
		// 	}).addTo(map);
		// }

	}

	function getNavigationInfo(control,code) {
	
		$.getJSON( "https://test.streamstats.usgs.gov/navigationservices/navigation/" + code, function( data ) {
		
			console.log('network nav option selected:',data);
			$(data.configuration).each(function(index,value){
			
				if (value.name === 'Start point location') {
					var requestObj = [value];
					
					L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
					
					map.on('click', function(e) {
						console.log('map clicked:',e.latlng);

						requestObj[0].value.coordinates = [e.latlng.lng,e.latlng.lat];
						
						var test = JSON.stringify(requestObj);
						console.log('request object modified:',test);
						L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
						map.off('click');
						control.state('loading');

						 $.ajax({
							  type: 'POST',
							  url: "https://test.streamstats.usgs.gov/navigationservices/navigation/" + code + "/route",
							  crossDomain: true,
							  data: test,
							  dataType: "json",
							  contentType: 'application/json; charset=UTF-8',
							  success: function(resultData) { 
								control.state('start');
								var geojson = L.geoJSON(resultData).addTo(map);
								map.fitBounds(geojson.getBounds());
							}
						});
					});;
				}
			});
		});
	}

</script>
</body>
</html>